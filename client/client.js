/** * the key for the id in the localstorage */var ID_STORE = "mobileHamsterId";/** * entry for not logged users   */var NOT_LOGGED_IN = "<li>not logged in yet</li>";/** * entry for empty lists */var EMPTY_LIST = "<li>Sorry not entries yet</li>";/** * the template for the number of messages and invites */var MESSAGES_AND_INVITES_TMPL = "{msgs} message(s) {invites} invite(s)";/** * the template for the list of invites  */var INVITE_TMPL = "\	<li id='{name}'>\		<a>\			<img src='{pic}'/>\			<h3>{name}</h3>\			<div>\				<img class='contactGender' src='gfx/{gender}.png' /> \				{flag} \				{online} \			</div>\			<div style='text-align: center' data-role='controlgroup' data-type='horizontal'>\				<a href='accept_{uid}' data-role='button'>Accept</a>\				<a href='decline_{uid}' data-role='button'>Decline</a>\			</div>\		</a>\	</li>";var id = null;/** * checks if the user is logged in. */function isLoggedIn() {    return id != null && id.length == 128;}/** * this function does a logIn call to the webservice */function logIn(event) {    event.preventDefault();    var user = $('#username').val();    var pwd = $('#password').val();    $.getJSON('server/login.php?user=' + user + '&pwd=' + pwd, function (data) {        id = data.code;        localStorage.setItem(ID_STORE, id);        $.mobile.changePage("#start");    });}/** * calls the log out webservice call and unsets the local id */function logOut(event) {    event.preventDefault();    $.getJSON('server/logout.php?id=' + id, function (data) {        id = null;        localStorage.setItem(ID_STORE, null);        $.mobile.changePage("#login");    });}/** * function that uses setTimeout to call loadMessageCount repeatedly */function loadMessageCountRepeatedly() {    loadMessageCount();    setTimeout('loadMessageCountRepeatedly()', 10000);}/** * loads the avaiable messages and invites */function loadMessageCount() {    if (!isLoggedIn()) {        $("#msgs").html("");    } else {        $.getJSON('server/message_num.php?id=' + id, function (data) {            var input = {                msgs: data.messages,                invites: data.invites            }            var html = $.nano(MESSAGES_AND_INVITES_TMPL, input);            $("#msgs").html(html);        });    }}function loadFriendsList() {    getUserList('server/friends.php?id=' + id, '#friendsList', true);}function loadFavoritesList() {    getUserList('server/favorites.php?id=' + id, '#favoritesList', true);}/** * loads a user list from the given url. Checks if the user is currently * logged, displays a spinner if wanted and pastes the result into a * list view. * * @param {String} url the url to load data drom * @param {String} targetId the id of the targeted list view * @param {Boolean} showLoading if true, a showPageLoadingMsg is called */function getUserList(url, targetId, showLoading) {    // check if logged in    if (!isLoggedIn()) {        $(targetId).html(NOT_LOGGED_IN);        $(targetId).listview("refresh");    } else {        // should we display some kind of spinner?        if (showLoading) {            $.mobile.showPageLoadingMsg();        }        // load the data from the given url        $.getJSON(url, function (data) {            // construct the list data            var listElements = "";            if (data.length == 0) {                listElements = EMPTY_LIST;            }            for (i = 0; i < data.length; i++) {                var user = data[i];                var name = data[i].name;                var pic = data[i].pic;                var gender = data[i].sex;                var flag = data[i].flagIcon != "" ? "<img class='contactCountry' src='" + data[i].flagIcon + "' />" : "";                var online = data[i].online ? "<span class='userOnline'>online</span>" : "";                listElements = listElements + "<li id='" + name + "'><a>" + "<img src='" + pic + "' />" + "<h3>" + name + "</h3>" + "<div>" + "<img class='contactGender' src='gfx/" + gender + ".png' />" + flag + online + "</div>" + "</a></li>";            }            // paste the list elements to the list            $(targetId).html(listElements).trigger('create');            $(targetId + "> li").click(clickToOpenProfile);            $(targetId).listview("refresh");            // if we displayed the spinner, we should remove it right now            if (showLoading) {                $.mobile.hidePageLoadingMsg();            }        });    }}/** * this function identifies the id of a user and opens the profile of the user. *  * @param {Object} e the event that triggered the call */function clickToOpenProfile(e) {    // identify the id by crawling up the tree to the enclosing <li>    var tgt = e.target;    while (tgt.nodeName != "LI") {                // buttons are not handled here        if (isButton(tgt)) {	        return ;        }                // go to the parent        tgt = tgt.parentNode;    }        // change to profile    var url = "#viewProfile?user=" + tgt.id;    $.mobile.changePage(url, {        "dataUrl": url    });}/** * checks if target is a jQuery mobile button (data-role="button"). *  * @param {Object} target * @return true, if it is a button, false otherwise */function isButton(target) {	var attribute = target.attributes["data-role"];    if (attribute == undefined) {        return false;    }    return attribute.nodeValue == 'button';}function loadInvitesList() {    var showLoading = true;    var url = 'server/invites.php?id=' + id;    var targetId = "#invitesList";    // check if logged in    if (!isLoggedIn()) {        $(targetId).html(NOT_LOGGED_IN);        $(targetId).listview("refresh");    } else {        $(targetId).html("");        // should we display some kind of spinner?        if (showLoading) {            $.mobile.showPageLoadingMsg();        }        // load the data from the given url        $.getJSON(url, function (data) {            // construct the list data            var listElements = "";            if (data.length == 0) {                listElements = EMPTY_LIST;            }            for (i = 0; i < data.length; i++) {                var user = data[i];                var input = {                    pic: user.pic,                    name: user.name,                    gender: user.sex,                    flag: (user.flagIcon != "" ? "<img class='contactCountry' src='" + user.flagIcon + "' />" : ""),                    online: (user.online ? "<span class='userOnline'>online</span>" : ""),                    uid: user.uid,                };                listElements = listElements + $.nano(INVITE_TMPL, input);            }            // paste the list elements to the list            $(targetId).html(listElements).trigger('create');            $(targetId + "> li").click(clickToOpenProfile);            $(targetId + " a").click(function(e) {        	    // identify the id by crawling up the tree to the enclosing <li>			    var tgt = e.target;				while (tgt.nodeName != "LI" && !isButton(tgt)) {        			        // go to the parent			        tgt = tgt.parentNode;		    	}		    	if(isButton(tgt)) {		    		var actionUid = tgt.attributes["href"].nodeValue.split("_");		    		var action = actionUid[0];		    		var uid = actionUid[1];					// now identify the surrounding <li>		    				    		while (tgt.nodeName != "LI") {			        	tgt = tgt.parentNode;		    		}		    				    		// hide the invite		    		$(tgt).hide(400);		    				    		// call the action on the server		    		var url = "server/invite_control.php?action="+action+"&uid="+user.uid+"&id="+id;		    		$.getJSON(url, function (data) {});		    				    		return false;		    	} 		    });            $(targetId).listview("refresh");            // if we displayed the spinner, we should remove it right now            if (showLoading) {                $.mobile.hidePageLoadingMsg();            }        });    }}function loadProfile(e, data) {    $.mobile.showPageLoadingMsg();    var user = $.getQuery('user');    var url = 'server/user.php?id=' + id + "&user=" + user;    $('#vp_content').html("").trigger('create');    $.getJSON(url, function (data) {        $('#vp_profileName').html(data.name);        var status = "";        if (data.status != "") {            status = $.nano("<p>{status}<br />{statusTime}</p>", data);        }        if (data.stats.Last_Activity == "online") {        	data.stats.Last_Activity = "<span class='userOnline'>online</span>";        }		var info = "";		for (index=0;index<data.info.length;index++) {			info+=$.nano("<tr><td class='bold'>{key}</td></tr><tr><td>{value}</td></tr>", data.info[index]);		}        var input = {            "avatar": data.avatar,            "status": status,            "stats": data.stats,            "info": info        }        var content = $.nano("\			<div class='center'>\				<img src={avatar} /> \				<br /> \				{status} \				<table>\					<tr><td class='bold'>Signed up:</td></tr><tr><td>{stats.Signed_up}</td></tr> \					<tr><td class='bold'>Last Activity:</td></tr><tr><td>{stats.Last_Activity}</td></tr> \					<tr><td class='bold'>Profile Viewed:</td></tr><tr><td>{stats.Profile_Viewed}</td></tr> \					<tr><td class='bold'>Rank:</td></tr><tr><td>{stats.Rank}</td></tr> \					<tr><td class='bold'>Comments:</td></tr><tr><td>{stats.Comments}</td></tr> \					{info}\				</table>\			</div>\			", input);        $('#vp_content').html(content).trigger('create');        $.mobile.hidePageLoadingMsg();    });}function appStart() {    // retrieve id from    id = localStorage.getItem(ID_STORE);    console.log("id after load: " + id);    // update all footer elements    $('.footer').html('mobile hamster by joachiml');    // set the call back for the login form.    $("#loginSubmit").click(logIn);    $("#logoutSubmit").click(logOut);    $('#friends').live('pageshow', loadFriendsList);    $('#favorites').live('pageshow', loadFavoritesList);    $('#invites').live('pageshow', loadInvitesList);    $('#viewProfile').live('pageshow', loadProfile);    loadMessageCountRepeatedly();    // make sure user is logged in    if (!isLoggedIn()) {        $.mobile.changePage('#login');    }}$(document).ready(appStart);